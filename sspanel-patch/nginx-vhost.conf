# ============================================================
# JA3 Guard — 业务服务器 Nginx 虚拟主机配置
# ============================================================
#
# 使用方法:
#   1. 将此文件复制到业务服务器: /etc/nginx/sites-available/sspanel.conf
#   2. 将 "sub.example.com" 替换为你的订阅域名
#   3. 将 "JA3_GUARD_IP" 替换为 JA3 Guard 服务器的 IP
#   4. 将 "/www/sspanel" 替换为你的 SSPanel 安装路径
#   5. 创建软链接: ln -s /etc/nginx/sites-available/sspanel.conf /etc/nginx/sites-enabled/
#   6. 测试配置: nginx -t
#   7. 重载: systemctl reload nginx
#
# 请求链路:
#   用户 → JA3 Guard (:443, TLS) → 本 Nginx (:80, HTTP) → PHP-FPM
#
# ============================================================

server {
    listen 80;
    server_name sub.example.com;      # ← 替换为你的订阅域名

    root /www/sspanel/public;          # ← 替换为 SSPanel 的 public 目录
    index index.php index.html;

    charset utf-8;

    # ─── 信任 JA3 Guard 的 X-Real-IP header ───
    # 只信任 JA3 Guard 服务器，防止 IP 伪造
    set_real_ip_from JA3_GUARD_IP;     # ← 替换为 JA3 Guard 服务器 IP（如 10.0.0.5 或 203.0.113.1）
    real_ip_header   X-Real-IP;
    real_ip_recursive on;

    # ─── 安全: 只允许 JA3 Guard 访问 ───
    # 如果业务服务器有公网 IP，建议只允许 JA3 Guard 的 IP 访问
    # 取消注释以下两行启用 IP 白名单:
    # allow JA3_GUARD_IP;
    # deny all;

    # ─── Laravel 路由 ───
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ─── PHP-FPM 处理 ───
    location ~ \.php$ {
        try_files $uri =404;

        fastcgi_pass unix:/run/php/php8.1-fpm.sock;   # ← 根据你的 PHP 版本调整
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;

        # 传递 JA3 Guard 的自定义 header 给 PHP
        # PHP 中可通过 $_SERVER['HTTP_X_JA3_TRUSTED'] 等访问
        fastcgi_param HTTP_X_FORWARDED_PROTO  $http_x_forwarded_proto;
        fastcgi_param HTTP_X_FORWARDED_HOST   $http_x_forwarded_host;
        fastcgi_param HTTP_X_REAL_IP          $http_x_real_ip;
    }

    # ─── 禁止访问隐藏文件 ───
    location ~ /\.(?!well-known) {
        deny all;
    }

    # ─── 日志 ───
    access_log /var/log/nginx/sspanel-access.log;
    error_log  /var/log/nginx/sspanel-error.log;
}
