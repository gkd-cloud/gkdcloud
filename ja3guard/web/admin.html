<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JA3 Guard</title>
<style>
:root {
  --bg: #0d1117; --surface: #161b22; --border: #30363d;
  --text: #c9d1d9; --text2: #8b949e; --text3: #484f58;
  --green: #3fb950; --red: #f85149; --blue: #58a6ff; --yellow: #d29922;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, 'SF Pro', system-ui, monospace; background: var(--bg); color: var(--text); }
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; height: 56px; }
header h1 { font-size: 16px; font-weight: 600; margin-right: 32px; }
header h1 span { color: var(--green); }
nav { display: flex; gap: 4px; flex-wrap: wrap; }
nav button { background: none; border: none; color: var(--text2); padding: 8px 16px; cursor: pointer; font-size: 14px; border-radius: 6px; }
nav button:hover { color: var(--text); background: rgba(255,255,255,0.05); }
nav button.active { color: var(--text); background: rgba(255,255,255,0.08); }
main { max-width: 1100px; margin: 24px auto; padding: 0 24px; }
.page { display: none; }
.page.active { display: block; }
.cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; }
.card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; margin-bottom: 4px; }
.card .value { font-size: 28px; font-weight: 600; }
.card .value.green { color: var(--green); }
.card .value.red { color: var(--red); }
.card .value.blue { color: var(--blue); }
table { width: 100%; border-collapse: collapse; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
th, td { text-align: left; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
th { background: rgba(255,255,255,0.03); color: var(--text2); font-weight: 500; font-size: 12px; text-transform: uppercase; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,0.02); }
.hash { font-family: monospace; font-size: 12px; color: var(--blue); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ua { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text2); font-size: 12px; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
.badge.ok { background: rgba(63,185,80,0.15); color: var(--green); }
.badge.no { background: rgba(248,81,73,0.15); color: var(--red); }
.badge.wl { background: rgba(88,166,255,0.15); color: var(--blue); }
button.btn { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; font-size: 13px; }
button.btn:hover { background: rgba(255,255,255,0.06); }
button.btn.primary { background: rgba(63,185,80,0.15); border-color: var(--green); color: var(--green); }
button.btn.danger { background: rgba(248,81,73,0.1); border-color: transparent; color: var(--red); }
button.btn.sm { padding: 3px 10px; font-size: 12px; }
button.btn.warn { background: rgba(210,153,34,0.15); border-color: var(--yellow); color: var(--yellow); }
.toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.toolbar h2 { font-size: 16px; font-weight: 600; }
.toolbar .btn-group { display: flex; gap: 8px; }
input[type=text] { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; font-size: 13px; outline: none; }
input[type=text]:focus { border-color: var(--blue); }
.form-row { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
.pagination { display: flex; justify-content: center; gap: 8px; margin-top: 16px; }
.toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle .slider { position: absolute; inset: 0; background: var(--text3); border-radius: 24px; cursor: pointer; transition: .2s; }
.toggle .slider:before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .2s; }
.toggle input:checked + .slider { background: var(--green); }
.toggle input:checked + .slider:before { transform: translateX(20px); }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; }
.setting-row .info { }
.setting-row .info .title { font-size: 14px; font-weight: 500; }
.setting-row .info .desc { font-size: 12px; color: var(--text2); margin-top: 2px; }
.empty { text-align: center; padding: 40px; color: var(--text3); }

/* Nginx 管理相关样式 */
.nx-layout { display: flex; gap: 16px; height: calc(100vh - 180px); min-height: 500px; }
.nx-sidebar { width: 240px; flex-shrink: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; }
.nx-sidebar-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.nx-sidebar-header span { font-size: 12px; color: var(--text2); text-transform: uppercase; font-weight: 500; }
.nx-list { flex: 1; overflow-y: auto; padding: 4px; }
.nx-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
.nx-item:hover { background: rgba(255,255,255,0.04); }
.nx-item.active { background: rgba(88,166,255,0.12); color: var(--blue); }
.nx-item .nx-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
.nx-item .nx-dot.off { background: var(--text3); }
.nx-editor { flex: 1; display: flex; flex-direction: column; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.nx-editor-header { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.nx-editor-header .nx-filename { font-size: 14px; font-weight: 500; color: var(--blue); }
.nx-editor-body { flex: 1; position: relative; }
.nx-editor-body textarea { width: 100%; height: 100%; background: var(--bg); color: var(--text); border: none; padding: 16px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 13px; line-height: 1.6; resize: none; outline: none; tab-size: 4; }
.nx-editor-footer { padding: 10px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.nx-status { padding: 12px 16px; border-top: 1px solid var(--border); }
.nx-status-bar { font-size: 12px; color: var(--text2); }
.nx-status-bar.ok { color: var(--green); }
.nx-status-bar.err { color: var(--red); }
.nx-info { display: flex; gap: 16px; margin-bottom: 16px; }
.nx-info .card { flex: 1; }
.nx-empty { display: flex; align-items: center; justify-content: center; flex: 1; color: var(--text3); font-size: 14px; }
.nx-new-form { padding: 16px; }
.nx-new-form input { width: 100%; margin-bottom: 8px; }

/* Nodes 管理样式 */
.node-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; margin-bottom: 24px; }
.node-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; position: relative; }
.node-card:hover { border-color: var(--text3); }
.node-card .node-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.node-card .node-name { font-size: 15px; font-weight: 600; }
.node-card .node-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.node-card .node-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
.node-card .node-dot.off { background: var(--text3); }
.node-card .node-info { font-size: 12px; color: var(--text2); line-height: 1.8; }
.node-card .node-info span { color: var(--text); }
.node-card .node-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.node-card .node-stat { text-align: center; }
.node-card .node-stat .num { font-size: 18px; font-weight: 600; }
.node-card .node-stat .lbl { font-size: 10px; color: var(--text2); text-transform: uppercase; }
.node-card .node-actions { display: flex; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 480px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
.modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-header h3 { font-size: 16px; font-weight: 600; }
.modal-body { padding: 20px; }
.modal-body label { display: block; font-size: 12px; color: var(--text2); margin-bottom: 4px; margin-top: 12px; text-transform: uppercase; }
.modal-body label:first-child { margin-top: 0; }
.modal-body input, .modal-body select, .modal-body textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 6px; font-size: 13px; outline: none; font-family: inherit; }
.modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus { border-color: var(--blue); }
.modal-body textarea { min-height: 80px; resize: vertical; font-family: 'SF Mono', monospace; }
.modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
.token-display { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; font-family: monospace; font-size: 12px; color: var(--blue); word-break: break-all; margin-top: 4px; cursor: pointer; }
.token-display:hover { border-color: var(--blue); }
</style>
</head>
<body>

<header>
  <h1>JA3 <span>Guard</span></h1>
  <nav>
    <button class="active" onclick="showPage('dashboard')">Dashboard</button>
    <button onclick="showPage('summary')">JA3 Fingerprints</button>
    <button onclick="showPage('whitelist')">Whitelist</button>
    <button onclick="showPage('logs')">Request Logs</button>
    <button onclick="showPage('nginx')">Nginx</button>
    <button onclick="showPage('nodes')">Nodes</button>
    <button onclick="showPage('settings')">Settings</button>
  </nav>
</header>

<main>

<!-- Dashboard -->
<div id="page-dashboard" class="page active">
  <div class="cards">
    <div class="card"><div class="label">Total Requests</div><div class="value blue" id="stat-total">-</div></div>
    <div class="card"><div class="label">Trusted (Whitelisted)</div><div class="value green" id="stat-trusted">-</div></div>
    <div class="card"><div class="label">Blocked (Unknown JA3)</div><div class="value red" id="stat-blocked">-</div></div>
  </div>
  <div class="toolbar"><h2>Recent Activity</h2><button class="btn sm" onclick="loadDashboard()">Refresh</button></div>
  <table>
    <thead><tr><th>Time</th><th>IP</th><th>JA3 Hash</th><th>User-Agent</th><th>Status</th></tr></thead>
    <tbody id="recent-logs"></tbody>
  </table>
</div>

<!-- JA3 Summary -->
<div id="page-summary" class="page">
  <div class="toolbar"><h2>JA3 Fingerprint Summary</h2><button class="btn sm" onclick="loadSummary()">Refresh</button></div>
  <table>
    <thead><tr><th>JA3 Hash</th><th>Count</th><th>Last UA</th><th>Last IP</th><th>Last Seen</th><th>Status</th><th>Action</th></tr></thead>
    <tbody id="summary-body"></tbody>
  </table>
</div>

<!-- Whitelist -->
<div id="page-whitelist" class="page">
  <div class="toolbar"><h2>Whitelist Management</h2></div>
  <div class="form-row">
    <input type="text" id="wl-hash" placeholder="JA3 Hash" style="width:340px">
    <input type="text" id="wl-note" placeholder="Note (e.g. iOS 17 SR)" style="width:200px">
    <button class="btn primary" onclick="addWhitelist()">Add</button>
  </div>
  <table>
    <thead><tr><th>JA3 Hash</th><th>Note</th><th>Added</th><th>Action</th></tr></thead>
    <tbody id="wl-body"></tbody>
  </table>
</div>

<!-- Request Logs -->
<div id="page-logs" class="page">
  <div class="toolbar"><h2>Request Logs</h2><button class="btn sm" onclick="loadLogs()">Refresh</button></div>
  <table>
    <thead><tr><th>Time</th><th>IP</th><th>JA3 Hash</th><th>User-Agent</th><th>Status</th></tr></thead>
    <tbody id="logs-body"></tbody>
  </table>
  <div class="pagination" id="logs-pagination"></div>
</div>

<!-- Nginx 管理 -->
<div id="page-nginx" class="page">
  <div class="toolbar">
    <h2>Nginx Sites</h2>
    <div class="btn-group">
      <button class="btn sm" onclick="nxTest()">Test Config</button>
      <button class="btn sm primary" onclick="nxReload()">Reload Nginx</button>
    </div>
  </div>
  <div id="nx-status-msg"></div>
  <div class="nx-layout">
    <!-- 左侧站点列表 -->
    <div class="nx-sidebar">
      <div class="nx-sidebar-header">
        <span>Sites</span>
        <button class="btn sm primary" onclick="nxNewSite()">+ New</button>
      </div>
      <div class="nx-list" id="nx-list"></div>
    </div>
    <!-- 右侧编辑器 -->
    <div class="nx-editor">
      <div id="nx-editor-wrap" style="display:none;flex-direction:column;flex:1;">
        <div class="nx-editor-header">
          <span class="nx-filename" id="nx-filename">-</span>
          <div class="btn-group">
            <button class="btn sm danger" onclick="nxDelete()">Delete</button>
            <button class="btn sm primary" onclick="nxSave()">Save</button>
          </div>
        </div>
        <div class="nx-editor-body">
          <textarea id="nx-content" spellcheck="false" placeholder="# Nginx server block configuration..."></textarea>
        </div>
        <div class="nx-editor-footer">
          <span class="nx-status-bar" id="nx-save-status"></span>
          <span style="font-size:12px;color:var(--text3)">Save: Ctrl+S</span>
        </div>
      </div>
      <div id="nx-empty" class="nx-empty">Select a site or create a new one</div>
    </div>
  </div>
</div>

<!-- Nodes 管理 -->
<div id="page-nodes" class="page">
  <div class="toolbar">
    <h2>Node Management</h2>
    <div class="btn-group">
      <button class="btn sm" onclick="loadNodes()">Refresh</button>
      <button class="btn sm primary" onclick="showNodeModal()">+ Add Node</button>
    </div>
  </div>
  <div class="node-grid" id="node-grid">
    <div class="empty" style="grid-column:1/-1">Loading nodes...</div>
  </div>
</div>

<!-- Node 添加/编辑模态框 -->
<div id="node-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeNodeModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="node-modal-title">Add Node</h3>
      <button class="btn sm" onclick="closeNodeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="node-edit-id">
      <label>Node Name</label>
      <input type="text" id="node-name" placeholder="e.g. hk-01">
      <label>Host (IP or Domain)</label>
      <input type="text" id="node-host" placeholder="e.g. 1.2.3.4">
      <label>SSH Port</label>
      <input type="text" id="node-ssh-port" placeholder="22" value="22">
      <label>SSH User</label>
      <input type="text" id="node-ssh-user" placeholder="root" value="root">
      <label>Auth Type</label>
      <select id="node-auth-type" onchange="toggleAuthFields()">
        <option value="password">Password</option>
        <option value="key">SSH Key</option>
      </select>
      <div id="auth-password-field">
        <label>SSH Password</label>
        <input type="text" id="node-ssh-pass" placeholder="SSH password">
      </div>
      <div id="auth-key-field" style="display:none">
        <label>SSH Private Key</label>
        <textarea id="node-ssh-key" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"></textarea>
      </div>
      <label>Note</label>
      <input type="text" id="node-note" placeholder="Optional note">
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeNodeModal()">Cancel</button>
      <button class="btn primary" onclick="saveNode()">Save</button>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="page-settings" class="page">
  <div class="toolbar"><h2>Settings</h2></div>
  <div class="setting-row">
    <div class="info">
      <div class="title">Request Logging</div>
      <div class="desc">Record all incoming JA3 fingerprints for analysis. Disable after collecting enough data.</div>
    </div>
    <label class="toggle"><input type="checkbox" id="set-log" onchange="updateSettings()"><span class="slider"></span></label>
  </div>
  <div class="setting-row">
    <div class="info">
      <div class="title">Domain</div>
      <div class="desc" id="set-domain">-</div>
    </div>
    <span style="color:var(--text3);font-size:13px">config.json</span>
  </div>
  <div class="setting-row">
    <div class="info">
      <div class="title">Upstream</div>
      <div class="desc" id="set-upstream">-</div>
    </div>
    <span style="color:var(--text3);font-size:13px">config.json</span>
  </div>
  <div class="setting-row">
    <div class="info">
      <div class="title">Cleanup Old Logs</div>
      <div class="desc">Remove request logs older than 30 days</div>
    </div>
    <button class="btn danger sm" onclick="cleanupLogs()">Cleanup Now</button>
  </div>
</div>

</main>

<script>
const API = '';
let logsPage = 1;

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.target.classList.add('active');
  const loaders = { dashboard: loadDashboard, summary: loadSummary, whitelist: loadWhitelist, logs: loadLogs, settings: loadSettings, nginx: loadNginx, nodes: loadNodes };
  if (loaders[name]) loaders[name]();
}

async function api(path, opts) {
  const res = await fetch(API + '/' + path, opts);
  return res.json();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- Dashboard ---
async function loadDashboard() {
  const stats = await api('api/stats');
  document.getElementById('stat-total').textContent = stats.total_requests;
  document.getElementById('stat-trusted').textContent = stats.trusted_count;
  document.getElementById('stat-blocked').textContent = stats.blocked_count;

  const data = await api('api/logs?page=1&size=20');
  const tbody = document.getElementById('recent-logs');
  if (!data.logs || data.logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty">No requests yet. Waiting for traffic...</td></tr>';
    return;
  }
  tbody.innerHTML = data.logs.map(l => `<tr>
    <td>${escHtml(l.ts)}</td>
    <td>${escHtml(l.ip)}</td>
    <td><span class="hash" title="${escHtml(l.ja3)}">${escHtml(l.ja3 || '(empty)')}</span></td>
    <td><span class="ua" title="${escHtml(l.ua)}">${escHtml(l.ua)}</span></td>
    <td><span class="badge ${l.ok ? 'ok' : 'no'}">${l.ok ? 'TRUSTED' : 'BLOCKED'}</span></td>
  </tr>`).join('');
}

// --- Summary ---
async function loadSummary() {
  const data = await api('api/logs/summary');
  const tbody = document.getElementById('summary-body');
  if (!data.summaries || data.summaries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty">No data yet</td></tr>';
    return;
  }
  tbody.innerHTML = data.summaries.map(s => `<tr>
    <td><span class="hash" title="${escHtml(s.ja3_hash)}">${escHtml(s.ja3_hash || '(empty)')}</span></td>
    <td>${s.count}</td>
    <td><span class="ua" title="${escHtml(s.last_ua)}">${escHtml(s.last_ua)}</span></td>
    <td>${escHtml(s.last_ip)}</td>
    <td>${escHtml(s.last_seen)}</td>
    <td>${s.in_whitelist ? '<span class="badge wl">WHITELISTED</span>' : '<span class="badge no">UNKNOWN</span>'}</td>
    <td>${s.in_whitelist ? '' : `<button class="btn primary sm" onclick="quickAdd('${escHtml(s.ja3_hash)}')">Add</button>`}</td>
  </tr>`).join('');
}

function quickAdd(hash) {
  const note = prompt('Note for this JA3 hash:', '');
  if (note === null) return;
  api('api/whitelist', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ja3_hash: hash, note: note})
  }).then(() => { loadSummary(); });
}

// --- Whitelist ---
async function loadWhitelist() {
  const data = await api('api/whitelist');
  const tbody = document.getElementById('wl-body');
  if (!data.entries || data.entries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="empty">Whitelist is empty. Add JA3 hashes from the Fingerprints tab.</td></tr>';
    return;
  }
  tbody.innerHTML = data.entries.map(e => `<tr>
    <td><span class="hash">${escHtml(e.ja3_hash)}</span></td>
    <td>${escHtml(e.note)}</td>
    <td style="color:var(--text2)">${escHtml(e.created_at)}</td>
    <td><button class="btn danger sm" onclick="removeWL('${escHtml(e.ja3_hash)}')">Remove</button></td>
  </tr>`).join('');
}

async function addWhitelist() {
  const hash = document.getElementById('wl-hash').value.trim();
  const note = document.getElementById('wl-note').value.trim();
  if (!hash) return alert('JA3 Hash is required');
  await api('api/whitelist', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ja3_hash: hash, note: note})
  });
  document.getElementById('wl-hash').value = '';
  document.getElementById('wl-note').value = '';
  loadWhitelist();
}

async function removeWL(hash) {
  if (!confirm('Remove this JA3 hash from whitelist?')) return;
  await api('api/whitelist/' + encodeURIComponent(hash), {method: 'DELETE'});
  loadWhitelist();
}

// --- Logs ---
async function loadLogs() {
  const data = await api('api/logs?page=' + logsPage + '&size=50');
  const tbody = document.getElementById('logs-body');
  if (!data.logs || data.logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty">No logs</td></tr>';
    document.getElementById('logs-pagination').innerHTML = '';
    return;
  }
  tbody.innerHTML = data.logs.map(l => `<tr>
    <td>${escHtml(l.ts)}</td>
    <td>${escHtml(l.ip)}</td>
    <td><span class="hash" title="${escHtml(l.ja3)}">${escHtml(l.ja3 || '(empty)')}</span></td>
    <td><span class="ua" title="${escHtml(l.ua)}">${escHtml(l.ua)}</span></td>
    <td><span class="badge ${l.ok ? 'ok' : 'no'}">${l.ok ? 'TRUSTED' : 'BLOCKED'}</span></td>
  </tr>`).join('');

  const totalPages = Math.ceil(data.total / data.size);
  let pag = '';
  if (logsPage > 1) pag += `<button class="btn sm" onclick="logsPage--;loadLogs()">Prev</button>`;
  pag += `<span style="color:var(--text2);font-size:13px;line-height:30px">${logsPage} / ${totalPages} (${data.total} total)</span>`;
  if (logsPage < totalPages) pag += `<button class="btn sm" onclick="logsPage++;loadLogs()">Next</button>`;
  document.getElementById('logs-pagination').innerHTML = pag;
}

// --- Settings ---
async function loadSettings() {
  const data = await api('api/settings');
  document.getElementById('set-log').checked = data.log_enabled;
  document.getElementById('set-domain').textContent = data.domain;
  document.getElementById('set-upstream').textContent = data.upstream;
}

async function updateSettings() {
  await api('api/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({log_enabled: document.getElementById('set-log').checked})
  });
}

async function cleanupLogs() {
  if (!confirm('Delete logs older than 30 days?')) return;
  await api('api/logs/cleanup', {method: 'POST'});
  alert('Done');
}

// ============================================================
// Nginx 管理
// ============================================================
let nxSites = [];
let nxCurrent = null;    // 当前选中的站点名
let nxDirty = false;     // 编辑器是否有未保存的修改

async function loadNginx() {
  const data = await api('api/nginx/sites');
  nxSites = data.sites || [];
  renderNxList();
  // 如果之前有选中的，重新选中
  if (nxCurrent) {
    const found = nxSites.find(s => s.name === nxCurrent);
    if (found) {
      nxSelect(found.name);
    } else {
      nxCurrent = null;
      nxShowEmpty();
    }
  }
}

function renderNxList() {
  const list = document.getElementById('nx-list');
  if (nxSites.length === 0) {
    list.innerHTML = '<div class="empty" style="padding:20px;font-size:13px">No sites configured</div>';
    return;
  }
  list.innerHTML = nxSites.map(s => `
    <div class="nx-item ${s.name === nxCurrent ? 'active' : ''}" onclick="nxSelect('${escHtml(s.name)}')">
      <span>${escHtml(s.name)}</span>
      <span class="nx-dot ${s.enabled ? '' : 'off'}" title="${s.enabled ? 'Enabled' : 'Disabled'}"></span>
    </div>
  `).join('');
}

function nxSelect(name) {
  if (nxDirty && nxCurrent !== name) {
    if (!confirm('You have unsaved changes. Discard?')) return;
  }
  nxCurrent = name;
  nxDirty = false;
  const site = nxSites.find(s => s.name === name);
  if (!site) return;

  document.getElementById('nx-empty').style.display = 'none';
  const wrap = document.getElementById('nx-editor-wrap');
  wrap.style.display = 'flex';
  document.getElementById('nx-filename').textContent = site.filename;
  document.getElementById('nx-content').value = site.content;
  document.getElementById('nx-save-status').textContent = 'Last saved: ' + site.updated_at;
  document.getElementById('nx-save-status').className = 'nx-status-bar';
  renderNxList();
}

function nxShowEmpty() {
  document.getElementById('nx-editor-wrap').style.display = 'none';
  document.getElementById('nx-empty').style.display = 'flex';
}

// 新建站点
function nxNewSite() {
  const name = prompt('Site name (letters, numbers, dots, dashes):', '');
  if (!name) return;
  if (!/^[a-zA-Z0-9][a-zA-Z0-9._-]{0,63}$/.test(name)) {
    alert('Invalid name. Use letters, numbers, dots, dashes only.');
    return;
  }

  const template = `# ${name} - Created via JA3 Guard
server {
    listen 127.0.0.1:8080;
    server_name example.com;

    root /www/example/public;
    index index.php index.html;

    location / {
        try_files $uri /index.php$is_args$args;
    }

    location ~ \\.php$ {
        try_files $uri =404;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\\. {
        deny all;
    }
}
`;

  // 先占位到列表，再打开编辑器
  nxSites.push({name: name, filename: name + '.conf', content: template, enabled: true, updated_at: 'new'});
  nxCurrent = name;
  nxDirty = true;
  renderNxList();

  document.getElementById('nx-empty').style.display = 'none';
  const wrap = document.getElementById('nx-editor-wrap');
  wrap.style.display = 'flex';
  document.getElementById('nx-filename').textContent = name + '.conf';
  document.getElementById('nx-content').value = template;
  document.getElementById('nx-save-status').textContent = 'Not saved yet';
  document.getElementById('nx-save-status').className = 'nx-status-bar err';
}

// 保存
async function nxSave() {
  if (!nxCurrent) return;
  const content = document.getElementById('nx-content').value;
  const status = document.getElementById('nx-save-status');

  try {
    const res = await api('api/nginx/sites', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: nxCurrent, content: content})
    });
    if (res.error) {
      status.textContent = 'Error: ' + res.error;
      status.className = 'nx-status-bar err';
      return;
    }
    nxDirty = false;
    status.textContent = 'Saved at ' + new Date().toLocaleTimeString();
    status.className = 'nx-status-bar ok';
    // 刷新列表
    await loadNginx();
  } catch (e) {
    status.textContent = 'Save failed: ' + e.message;
    status.className = 'nx-status-bar err';
  }
}

// 删除
async function nxDelete() {
  if (!nxCurrent) return;
  if (!confirm('Delete site "' + nxCurrent + '"? This cannot be undone.')) return;
  const res = await api('api/nginx/sites/' + encodeURIComponent(nxCurrent), {method: 'DELETE'});
  if (res.error) {
    alert('Error: ' + res.error);
    return;
  }
  nxCurrent = null;
  nxDirty = false;
  nxShowEmpty();
  await loadNginx();
}

// 测试配置
async function nxTest() {
  const msg = document.getElementById('nx-status-msg');
  msg.innerHTML = '<div style="padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:13px;margin-bottom:12px;color:var(--text2)">Testing...</div>';
  const res = await api('api/nginx/test', {method: 'POST'});
  if (res.ok) {
    msg.innerHTML = '<div style="padding:8px 12px;background:rgba(63,185,80,0.1);border:1px solid var(--green);border-radius:6px;font-size:13px;margin-bottom:12px;color:var(--green)">nginx -t OK</div>';
  } else {
    msg.innerHTML = `<div style="padding:8px 12px;background:rgba(248,81,73,0.1);border:1px solid var(--red);border-radius:6px;font-size:13px;margin-bottom:12px;color:var(--red);white-space:pre-wrap">${escHtml(res.output)}</div>`;
  }
  setTimeout(() => { msg.innerHTML = ''; }, 8000);
}

// Reload
async function nxReload() {
  const msg = document.getElementById('nx-status-msg');
  const res = await api('api/nginx/reload', {method: 'POST'});
  if (res.error) {
    msg.innerHTML = `<div style="padding:8px 12px;background:rgba(248,81,73,0.1);border:1px solid var(--red);border-radius:6px;font-size:13px;margin-bottom:12px;color:var(--red);white-space:pre-wrap">${escHtml(res.error)}</div>`;
  } else {
    msg.innerHTML = `<div style="padding:8px 12px;background:rgba(63,185,80,0.1);border:1px solid var(--green);border-radius:6px;font-size:13px;margin-bottom:12px;color:var(--green)">Nginx reloaded at ${res.time}</div>`;
  }
  setTimeout(() => { msg.innerHTML = ''; }, 5000);
}

// 标记 dirty
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('nx-content');
  ta.addEventListener('input', () => { nxDirty = true; });
  // Ctrl+S 快捷保存
  ta.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      nxSave();
    }
    // Tab 缩进
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      ta.value = ta.value.substring(0, start) + '    ' + ta.value.substring(end);
      ta.selectionStart = ta.selectionEnd = start + 4;
      nxDirty = true;
    }
  });
});

// ============================================================
// Nodes 管理
// ============================================================
let nodesList = [];

async function loadNodes() {
  const data = await api('api/nodes');
  nodesList = data.nodes || [];
  renderNodes();
}

function renderNodes() {
  const grid = document.getElementById('node-grid');
  if (nodesList.length === 0) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px">No nodes configured. Click "+ Add Node" to get started.</div>';
    return;
  }
  grid.innerHTML = nodesList.map(n => {
    const online = n.online;
    const st = n.status || {};
    return `
    <div class="node-card">
      <div class="node-header">
        <div>
          <span class="node-dot ${online ? 'on' : 'off'}"></span>
          <span class="node-name">${escHtml(n.name)}</span>
        </div>
        <span class="badge ${online ? 'ok' : 'no'}">${online ? 'ONLINE' : 'OFFLINE'}</span>
      </div>
      <div class="node-info">
        Host: <span>${escHtml(n.host)}:${n.ssh_port}</span><br>
        Auth: <span>${n.auth_type === 'key' ? 'SSH Key' : 'Password'}</span> (${escHtml(n.ssh_user)})<br>
        ${st.domain ? `Domain: <span>${escHtml(st.domain)}</span><br>` : ''}
        ${st.upstream ? `Upstream: <span>${escHtml(st.upstream)}</span><br>` : ''}
        ${n.last_heartbeat ? `Last seen: <span>${escHtml(n.last_heartbeat)}</span>` : 'Never connected'}
      </div>
      ${online && st ? `
      <div class="node-stats">
        <div class="node-stat"><div class="num blue">${st.total_requests || 0}</div><div class="lbl">Requests</div></div>
        <div class="node-stat"><div class="num green">${st.trusted_count || 0}</div><div class="lbl">Trusted</div></div>
        <div class="node-stat"><div class="num red">${st.blocked_count || 0}</div><div class="lbl">Blocked</div></div>
      </div>` : ''}
      <div class="node-actions">
        <button class="btn sm primary" onclick="sshTest('${escHtml(n.id)}',this)">Test SSH</button>
        <button class="btn sm" onclick="sshInfo('${escHtml(n.id)}')">System Info</button>
        <button class="btn sm" onclick="showNodeToken('${escHtml(n.id)}')">Token</button>
        <button class="btn sm" onclick="editNode('${escHtml(n.id)}')">Edit</button>
        <button class="btn sm danger" onclick="deleteNode('${escHtml(n.id)}','${escHtml(n.name)}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function toggleAuthFields() {
  const authType = document.getElementById('node-auth-type').value;
  document.getElementById('auth-password-field').style.display = authType === 'password' ? 'block' : 'none';
  document.getElementById('auth-key-field').style.display = authType === 'key' ? 'block' : 'none';
}

function showNodeModal(editData) {
  document.getElementById('node-modal').style.display = 'flex';
  if (editData) {
    document.getElementById('node-modal-title').textContent = 'Edit Node';
    document.getElementById('node-edit-id').value = editData.id || '';
    document.getElementById('node-name').value = editData.name || '';
    document.getElementById('node-host').value = editData.host || '';
    document.getElementById('node-ssh-port').value = editData.ssh_port || 22;
    document.getElementById('node-ssh-user').value = editData.ssh_user || 'root';
    document.getElementById('node-auth-type').value = editData.auth_type || 'password';
    document.getElementById('node-ssh-pass').value = editData.ssh_pass || '';
    document.getElementById('node-ssh-key').value = editData.ssh_key || '';
    document.getElementById('node-note').value = editData.note || '';
  } else {
    document.getElementById('node-modal-title').textContent = 'Add Node';
    document.getElementById('node-edit-id').value = '';
    document.getElementById('node-name').value = '';
    document.getElementById('node-host').value = '';
    document.getElementById('node-ssh-port').value = '22';
    document.getElementById('node-ssh-user').value = 'root';
    document.getElementById('node-auth-type').value = 'password';
    document.getElementById('node-ssh-pass').value = '';
    document.getElementById('node-ssh-key').value = '';
    document.getElementById('node-note').value = '';
  }
  toggleAuthFields();
}

function closeNodeModal() {
  document.getElementById('node-modal').style.display = 'none';
}

async function saveNode() {
  const id = document.getElementById('node-edit-id').value;
  const payload = {
    name: document.getElementById('node-name').value.trim(),
    host: document.getElementById('node-host').value.trim(),
    ssh_port: parseInt(document.getElementById('node-ssh-port').value) || 22,
    ssh_user: document.getElementById('node-ssh-user').value.trim() || 'root',
    auth_type: document.getElementById('node-auth-type').value,
    ssh_pass: document.getElementById('node-ssh-pass').value,
    ssh_key: document.getElementById('node-ssh-key').value,
    note: document.getElementById('node-note').value.trim(),
  };

  if (!payload.name) return alert('Node name is required');
  if (!payload.host) return alert('Host is required');

  let res;
  if (id) {
    res = await api('api/nodes/' + encodeURIComponent(id), {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
  } else {
    res = await api('api/nodes', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
  }

  if (res.error) {
    alert('Error: ' + res.error);
    return;
  }

  closeNodeModal();
  await loadNodes();
}

async function editNode(id) {
  const res = await api('api/nodes/' + encodeURIComponent(id));
  if (res.error) {
    alert('Error: ' + res.error);
    return;
  }
  showNodeModal(res);
}

async function deleteNode(id, name) {
  if (!confirm('Delete node "' + name + '"? This cannot be undone.')) return;
  const res = await api('api/nodes/' + encodeURIComponent(id), {method: 'DELETE'});
  if (res.error) {
    alert('Error: ' + res.error);
    return;
  }
  await loadNodes();
}

// --- SSH Operations ---
async function sshTest(id, btn) {
  const orig = btn.textContent;
  btn.textContent = 'Testing...';
  btn.disabled = true;
  try {
    const res = await api('api/nodes/' + encodeURIComponent(id) + '/ssh/test', {method: 'POST'});
    if (res.ok) {
      btn.textContent = 'OK!';
      btn.style.color = 'var(--green)';
    } else {
      btn.textContent = 'Failed';
      btn.style.color = 'var(--red)';
      alert('SSH Test Failed: ' + res.error);
    }
  } catch (e) {
    btn.textContent = 'Error';
    btn.style.color = 'var(--red)';
  }
  setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.disabled = false; }, 3000);
}

async function sshInfo(id) {
  const node = nodesList.find(n => n.id === id);
  if (!node) return;

  const html = `
    <div class="modal-overlay" id="sshinfo-modal" onclick="if(event.target===this)this.remove()" style="display:flex">
      <div class="modal" style="width:480px">
        <div class="modal-header">
          <h3>System Info: ${escHtml(node.name)}</h3>
          <button class="btn sm" onclick="document.getElementById('sshinfo-modal').remove()">&times;</button>
        </div>
        <div class="modal-body">
          <div style="text-align:center;padding:20px;color:var(--text2)">Connecting via SSH...</div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);

  try {
    const res = await api('api/nodes/' + encodeURIComponent(id) + '/ssh/info');
    const modal = document.getElementById('sshinfo-modal');
    if (!modal) return;
    const body = modal.querySelector('.modal-body');
    if (res.error) {
      body.innerHTML = `<div style="color:var(--red);padding:12px">${escHtml(res.error)}</div>`;
      return;
    }
    body.innerHTML = Object.entries(res).map(([k,v]) => `
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px">
        <span style="color:var(--text2)">${escHtml(k)}</span>
        <span>${escHtml(v)}</span>
      </div>
    `).join('');
  } catch (e) {
    const modal = document.getElementById('sshinfo-modal');
    if (modal) modal.querySelector('.modal-body').innerHTML = `<div style="color:var(--red);padding:12px">Connection failed: ${escHtml(e.message)}</div>`;
  }
}

function showNodeToken(id) {
  const node = nodesList.find(n => n.id === id);
  if (!node) return;
  const token = node.token;
  const html = `
    <div class="modal-overlay" id="token-modal" onclick="if(event.target===this)this.remove()" style="display:flex">
      <div class="modal" style="width:420px">
        <div class="modal-header">
          <h3>Node Token: ${escHtml(node.name)}</h3>
          <button class="btn sm" onclick="document.getElementById('token-modal').remove()">&times;</button>
        </div>
        <div class="modal-body">
          <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Use this token in the node's config.json as <code>node_token</code>. Click to copy.</p>
          <div class="token-display" onclick="navigator.clipboard.writeText('${escHtml(token)}');this.style.borderColor='var(--green)';setTimeout(()=>this.style.borderColor='',1000)">${escHtml(token)}</div>
          <label style="margin-top:16px">Node config.json example:</label>
          <textarea readonly style="min-height:120px;font-size:12px">{
  "mode": "node",
  "domain": "your-domain.com",
  "upstream": "http://127.0.0.1:8080",
  "admin_password": "your-password",
  "guard_secret": "your-secret",
  "master_url": "${location.protocol}//${location.host}",
  "node_token": "${escHtml(token)}",
  "node_name": "${escHtml(node.name)}",
  "report_interval": 60
}</textarea>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

// Init
loadDashboard();
</script>
</body>
</html>
