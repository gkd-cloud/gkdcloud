; ============================================================
; PHP-FPM 高性能优化配置 - www.conf
; 适用于: 宝塔面板 PHP 7.4
; 路径: /www/server/php/74/etc/php-fpm.d/www.conf
;
; 使用方法:
;   1. 备份原文件: cp /www/server/php/74/etc/php-fpm.d/www.conf /www/server/php/74/etc/php-fpm.d/www.conf.bak
;   2. 用本文件覆盖或修改对应参数
;   3. 重启 PHP-FPM: /etc/init.d/php-fpm-74 restart
; ============================================================

[www]
user = www
group = www

listen = /tmp/php-cgi-74.sock
listen.backlog = 8192
listen.owner = www
listen.group = www
listen.mode = 0666

; ============================================================
; 进程管理 - 核心参数
; ============================================================

; 使用 static 模式: 预先创建固定数量的 worker，避免动态创建的开销
; 如果内存不是很宽裕可以用 dynamic
pm = static

; 最大子进程数
; 计算公式: 可用内存(MB) / 每个 PHP 进程平均内存(约 40-80MB)
; 8GB 内存服务器建议: 100-150
; 16GB 内存服务器建议: 200-300
; 32GB 内存服务器建议: 400-500
; >>> 根据你的实际内存修改此值 <<<
pm.max_children = 150

; dynamic 模式下的参数 (如果 pm = dynamic 则取消注释)
;pm.start_servers = 50
;pm.min_spare_servers = 30
;pm.max_spare_servers = 100

; 每个子进程处理多少个请求后自动重启 (防止内存泄漏)
pm.max_requests = 1000

; ============================================================
; 超时配置
; ============================================================

; 请求超时时间 (秒) - 超过此时间强制终止
; 当前你的是约 100s 导致大量进程被卡住，这里设为 300s
; 但更重要的是优化代码/数据库让请求快速完成
request_terminate_timeout = 300

; 慢请求日志阈值 (秒) - 超过此时间记录到慢日志
request_slowlog_timeout = 5

; 慢日志文件路径
slowlog = /www/server/php/74/var/log/slow.log

; ============================================================
; 其他优化
; ============================================================

; 打开文件描述符限制
rlimit_files = 65536
rlimit_core = 0

; 捕获 worker 输出
catch_workers_output = yes

; 清理环境变量
clear_env = no
